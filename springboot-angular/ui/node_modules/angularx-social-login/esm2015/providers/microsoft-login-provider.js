import { __awaiter } from "tslib";
import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
/**
 * Protocol modes supported by MSAL.
 */
export var ProtocolMode;
(function (ProtocolMode) {
    ProtocolMode["AAD"] = "AAD";
    ProtocolMode["OIDC"] = "OIDC";
})(ProtocolMode || (ProtocolMode = {}));
const COMMON_AUTHORITY = 'https://login.microsoftonline.com/common/';
/**
 * Microsoft Authentication using MSAL v2: https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser
 */
export class MicrosoftLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = {
            authority: COMMON_AUTHORITY,
            scopes: ['openid', 'email', 'profile', 'User.Read'],
            knownAuthorities: [],
            protocolMode: ProtocolMode.AAD,
            clientCapabilities: [],
            cacheLocation: 'sessionStorage'
        };
        this.initOptions = Object.assign(Object.assign({}, this.initOptions), initOptions);
    }
    initialize() {
        return new Promise((resolve, reject) => {
            this.loadScript(MicrosoftLoginProvider.PROVIDER_ID, 'https://alcdn.msauth.net/browser/2.13.1/js/msal-browser.js', () => {
                var _a;
                try {
                    const config = {
                        auth: {
                            clientId: this.clientId,
                            redirectUri: (_a = this.initOptions.redirect_uri) !== null && _a !== void 0 ? _a : location.origin,
                            authority: this.initOptions.authority,
                            knownAuthorities: this.initOptions.knownAuthorities,
                            protocolMode: this.initOptions.protocolMode,
                            clientCapabilities: this.initOptions.clientCapabilities
                        },
                        cache: !this.initOptions.cacheLocation ? null : {
                            cacheLocation: this.initOptions.cacheLocation
                        }
                    };
                    this._instance = new msal.PublicClientApplication(config);
                    resolve();
                }
                catch (e) {
                    reject(e);
                }
            });
        });
    }
    getSocialUser(loginResponse) {
        return new Promise((resolve, reject) => {
            //After login, use Microsoft Graph API to get user info
            let meRequest = new XMLHttpRequest();
            meRequest.onreadystatechange = () => {
                if (meRequest.readyState == 4) {
                    try {
                        if (meRequest.status == 200) {
                            let userInfo = JSON.parse(meRequest.responseText);
                            let user = new SocialUser();
                            user.provider = MicrosoftLoginProvider.PROVIDER_ID;
                            user.id = loginResponse.idToken;
                            user.authToken = loginResponse.accessToken;
                            user.name = loginResponse.idTokenClaims.name;
                            user.email = loginResponse.account.username;
                            user.idToken = loginResponse.idToken;
                            user.response = loginResponse;
                            user.firstName = userInfo.givenName;
                            user.lastName = userInfo.surname;
                            resolve(user);
                        }
                        else {
                            reject(`Error retrieving user info: ${meRequest.status}`);
                        }
                    }
                    catch (err) {
                        reject(err);
                    }
                }
            };
            //Microsoft Graph ME Endpoint: https://docs.microsoft.com/en-us/graph/api/user-get?view=graph-rest-1.0&tabs=http
            meRequest.open('GET', 'https://graph.microsoft.com/v1.0/me');
            meRequest.setRequestHeader('Authorization', `Bearer ${loginResponse.accessToken}`);
            try {
                meRequest.send();
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return __awaiter(this, void 0, void 0, function* () {
            const accounts = this._instance.getAllAccounts();
            if ((accounts === null || accounts === void 0 ? void 0 : accounts.length) > 0) {
                const loginResponse = yield this._instance.ssoSilent({
                    scopes: this.initOptions.scopes,
                    loginHint: accounts[0].username
                });
                return yield this.getSocialUser(loginResponse);
            }
            else {
                throw `No user is currently logged in with ${MicrosoftLoginProvider.PROVIDER_ID}`;
            }
        });
    }
    signIn() {
        return __awaiter(this, void 0, void 0, function* () {
            const loginResponse = yield this._instance.loginPopup({
                scopes: this.initOptions.scopes
            });
            return yield this.getSocialUser(loginResponse);
        });
    }
    signOut(revoke) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            const accounts = this._instance.getAllAccounts();
            if ((accounts === null || accounts === void 0 ? void 0 : accounts.length) > 0) {
                yield this._instance.logoutPopup({
                    account: accounts[0],
                    postLogoutRedirectUri: (_b = (_a = this.initOptions.logout_redirect_uri) !== null && _a !== void 0 ? _a : this.initOptions.redirect_uri) !== null && _b !== void 0 ? _b : location.href
                });
            }
        });
    }
}
MicrosoftLoginProvider.PROVIDER_ID = 'MICROSOFT';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWljcm9zb2Z0LWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvbWljcm9zb2Z0LWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFckQ7O0dBRUc7QUFDSCxNQUFNLENBQU4sSUFBWSxZQUdYO0FBSEQsV0FBWSxZQUFZO0lBQ3RCLDJCQUFXLENBQUE7SUFDWCw2QkFBYSxDQUFBO0FBQ2YsQ0FBQyxFQUhXLFlBQVksS0FBWixZQUFZLFFBR3ZCO0FBZ0ZELE1BQU0sZ0JBQWdCLEdBQVcsMkNBQTJDLENBQUM7QUFFN0U7O0dBRUc7QUFDSCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsaUJBQWlCO0lBYTNELFlBQ1UsUUFBZ0IsRUFDeEIsV0FBOEI7UUFFOUIsS0FBSyxFQUFFLENBQUM7UUFIQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBVmxCLGdCQUFXLEdBQXFCO1lBQ3RDLFNBQVMsRUFBRSxnQkFBZ0I7WUFDM0IsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxDQUFDO1lBQ25ELGdCQUFnQixFQUFFLEVBQUU7WUFDcEIsWUFBWSxFQUFFLFlBQVksQ0FBQyxHQUFHO1lBQzlCLGtCQUFrQixFQUFFLEVBQUU7WUFDdEIsYUFBYSxFQUFFLGdCQUFnQjtTQUNoQyxDQUFDO1FBUUEsSUFBSSxDQUFDLFdBQVcsbUNBQ1gsSUFBSSxDQUFDLFdBQVcsR0FDaEIsV0FBVyxDQUNmLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFD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akQsSUFBSSxDQUFBLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxNQUFNLElBQUcsQ0FBQyxFQUFFO2dCQUN4QixNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO29CQUMvQixPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztvQkFDcEIscUJBQXFCLEVBQUUsTUFBQSxNQUFBLElBQUksQ0FBQyxXQUFXLENBQUMsbUJBQW1CLG1DQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxtQ0FBSSxRQUFRLENBQUMsSUFBSTtpQkFDOUcsQ0FBQyxDQUFBO2FBQ0g7O0tBQ0Y7O0FBNUhzQixrQ0FBVyxHQUFXLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi4vZW50aXRpZXMvYmFzZS1sb2dpbi1wcm92aWRlcic7XG5pbXBvcnQgeyBTb2NpYWxVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvc29jaWFsLXVzZXInO1xuXG4vKipcbiAqIFByb3RvY29sIG1vZGVzIHN1cHBvcnRlZCBieSBNU0FMLlxuICovXG5leHBvcnQgZW51bSBQcm90b2NvbE1vZGUge1xuICBBQUQgPSAnQUFEJyxcbiAgT0lEQyA9ICdPSURDJ1xufVxuXG4vKipcbiAqIEluaXRpYWxpemF0aW9uIE9wdGlvbnMgZm9yIE1pY3Jvc29mdCBQcm92aWRlcjogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL2Jsb2IvZGV2L2xpYi9tc2FsLWJyb3dzZXIvZG9jcy9pbml0aWFsaXphdGlvbi5tZFxuICogRGV0YWlscyAobm90IGFsbCBvcHRpb25zIGFyZSBzdXBwb3J0ZWQpOiBodHRwczovL2dpdGh1Yi5jb20vQXp1cmVBRC9taWNyb3NvZnQtYXV0aGVudGljYXRpb24tbGlicmFyeS1mb3ItanMvYmxvYi9kZXYvbGliL21zYWwtYnJvd3Nlci9kb2NzL2NvbmZpZ3VyYXRpb24ubWRcbiAqL1xuZXhwb3J0IHR5cGUgTWljcm9zb2Z0T3B0aW9ucyA9IHtcbiAgcmVkaXJlY3RfdXJpPzogc3RyaW5nLFxuICBsb2dvdXRfcmVkaXJlY3RfdXJpPzogc3RyaW5nLFxuICBhdXRob3JpdHk/OiBzdHJpbmcsXG4gIGtub3duQXV0aG9yaXRpZXM/OiBzdHJpbmdbXSxcbiAgcHJvdG9jb2xNb2RlPzogUHJvdG9jb2xNb2RlLFxuICBjbGllbnRDYXBhYmlsaXRpZXM/OiBzdHJpbmdbXSxcbiAgY2FjaGVMb2NhdGlvbj86IHN0cmluZyxcbiAgc2NvcGVzPzogc3RyaW5nW11cbn07XG5cbi8vIENvbGxlY3Rpb24gb2YgaW50ZXJuYWwgTVNBTCBpbnRlcmZhY2VzIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9BenVyZUFEL21pY3Jvc29mdC1hdXRoZW50aWNhdGlvbi1saWJyYXJ5LWZvci1qcy90cmVlL2Rldi9saWIvbXNhbC1icm93c2VyL3NyY1xuXG5pbnRlcmZhY2UgTVNBTEFjY291bnQge1xuICBlbnZpcm9ubWVudDogc3RyaW5nO1xuICBob21lQWNjb3VudElkOiBzdHJpbmc7XG4gIHRlbmFudElkOiBzdHJpbmc7XG4gIHVzZXJuYW1lOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBNU0dyYXBoVXNlckluZm8ge1xuICBidXNpbmVzc1Bob25lczogc3RyaW5nW107XG4gIGRpc3BsYXlOYW1lOiBzdHJpbmc7XG4gIGdpdmVuTmFtZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xuICBqb2JUaXRsZTogc3RyaW5nO1xuICBtYWlsOiBzdHJpbmc7XG4gIG1vYmlsZVBob25lOiBzdHJpbmc7XG4gIG9mZmljZUxvY2F0aW9uOiBzdHJpbmc7XG4gIHByZWZlcnJlZExhbmd1YWdlOiBzdHJpbmc7XG4gIHN1cm5hbWU6IHN0cmluZztcbiAgdXNlclByaW5jaXBhbE5hbWU6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE1TQUxMb2dpblJlcXVlc3Qge1xuICBzY29wZXM/OiBzdHJpbmdbXTtcbiAgc2lkPzogc3RyaW5nO1xuICBsb2dpbkhpbnQ/OiBzdHJpbmc7XG4gIGRvbWFpbkhpbnQ/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBNU0FMTG9naW5SZXNwb25zZSB7XG4gIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gIGFjY291bnQ6IE1TQUxBY2NvdW50O1xuICBleHBpcmVzT246IERhdGU7XG4gIGV4dEV4cGlyZXNPbjogRGF0ZTtcbiAgZmFtaWx5SWQ6IHN0cmluZztcbiAgZnJvbUNhY2hlOiBib29sZWFuO1xuICBpZFRva2VuOiBzdHJpbmc7XG4gIGlkVG9rZW5DbGFpbXM6IGFueTtcbiAgc2NvcGVzOiBzdHJpbmdbXTtcbiAgc3RhdGU6IHN0cmluZztcbiAgdGVuYW50SWQ6IHN0cmluZztcbiAgdW5pcXVlSWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE1TQUxMb2dvdXRSZXF1ZXN0IHtcbiAgYWNjb3VudD86IE1TQUxBY2NvdW50O1xuICBwb3N0TG9nb3V0UmVkaXJlY3RVcmk/OiBzdHJpbmc7XG4gIGF1dGhvcml0eT86IHN0cmluZztcbiAgY29ycmVsYXRpb25JZD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE1TQUxDbGllbnRBcHBsaWNhdGlvbiB7XG4gIGdldEFsbEFjY291bnRzKCk6IE1TQUxBY2NvdW50W107XG4gIGxvZ291dFBvcHVwKGxvZ291dFJlcXVlc3Q/OiBNU0FMTG9nb3V0UmVxdWVzdCk6IFByb21pc2U8dm9pZD47XG4gIGxvZ2luUG9wdXAobG9naW5SZXF1ZXN0OiBNU0FMTG9naW5SZXF1ZXN0KTogUHJvbWlzZTxNU0FMTG9naW5SZXNwb25zZT47XG4gIHNzb1NpbGVudChsb2dpblJlcXVlc3Q6IE1TQUxMb2dpblJlcXVlc3QpOiBQcm9taXNlPE1TQUxMb2dpblJlc3BvbnNlPjtcbiAgYWNxdWlyZVRva2VuU2lsZW50KGxvZ2luUmVxdWVzdDogTVNBTExvZ2luUmVxdWVzdCk6IFByb21pc2U8TVNBTExvZ2luUmVzcG9uc2U+O1xuICBnZXRBY2NvdW50QnlIb21lSWQoaG9tZUFjY291bnRJZDogc3RyaW5nKTogTVNBTEFjY291bnQ7XG59XG5cbmRlY2xhcmUgbGV0IG1zYWw6IGFueTtcblxuY29uc3QgQ09NTU9OX0FVVEhPUklUWTogc3RyaW5nID0gJ2h0dHBzOi8vbG9naW4ubWljcm9zb2Z0b25saW5lLmNvbS9jb21tb24vJztcblxuLyoqXG4gKiBNaWNyb3NvZnQgQXV0aGVudGljYXRpb24gdXNpbmcgTVNBTCB2MjogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL3RyZWUvZGV2L2xpYi9tc2FsLWJyb3dzZXJcbiAqL1xuZXhwb3J0IGNsYXNzIE1pY3Jvc29mdExvZ2luUHJvdmlkZXIgZXh0ZW5kcyBCYXNlTG9naW5Qcm92aWRlciB7XG4gIHByaXZhdGUgX2luc3RhbmNlOiBNU0FMQ2xpZW50QXBwbGljYXRpb247XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUFJPVklERVJfSUQ6IHN0cmluZyA9ICdNSUNST1NPRlQnO1xuXG4gIHByaXZhdGUgaW5pdE9wdGlvbnM6IE1pY3Jvc29mdE9wdGlvbnMgPSB7XG4gICAgYXV0aG9yaXR5OiBDT01NT05fQVVUSE9SSVRZLFxuICAgIHNjb3BlczogWydvcGVuaWQnLCAnZW1haWwnLCAncHJvZmlsZScsICdVc2VyLlJlYWQnXSxcbiAgICBrbm93bkF1dGhvcml0aWVzOiBbXSxcbiAgICBwcm90b2NvbE1vZGU6IFByb3RvY29sTW9kZS5BQUQsXG4gICAgY2xpZW50Q2FwYWJpbGl0aWVzOiBbXSxcbiAgICBjYWNoZUxvY2F0aW9uOiAnc2Vzc2lvblN0b3JhZ2UnXG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjbGllbnRJZDogc3RyaW5nLFxuICAgIGluaXRPcHRpb25zPzogTWljcm9zb2Z0T3B0aW9uc1xuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHtcbiAgICAgIC4uLnRoaXMuaW5pdE9wdGlvbnMsXG4gICAgICAuLi5pbml0T3B0aW9uc1xuICAgIH07XG4gIH1cblxuICBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmxvYWRTY3JpcHQoXG4gICAgICAgIE1pY3Jvc29mdExvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXG4gICAgICAgICdodHRwczovL2FsY2RuLm1zYXV0aC5uZXQvYnJvd3Nlci8yLjEzLjEvanMvbXNhbC1icm93c2VyLmpzJyxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAgICAgICAgIGF1dGg6IHtcbiAgICAgICAgICAgICAgICBjbGllbnRJZDogdGhpcy5jbGllbnRJZCxcbiAgICAgICAgICAgICAgICByZWRpcmVjdFVyaTogdGhpcy5pbml0T3B0aW9ucy5yZWRpcmVjdF91cmkgPz8gbG9jYXRpb24ub3JpZ2luLFxuICAgICAgICAgICAgICAgIGF1dGhvcml0eTogdGhpcy5pbml0T3B0aW9ucy5hdXRob3JpdHksXG4gICAgICAgICAgICAgICAga25vd25BdXRob3JpdGllczogdGhpcy5pbml0T3B0aW9ucy5rbm93bkF1dGhvcml0aWVzLFxuICAgICAgICAgICAgICAgIHByb3RvY29sTW9kZTogdGhpcy5pbml0T3B0aW9ucy5wcm90b2NvbE1vZGUsXG4gICAgICAgICAgICAgICAgY2xpZW50Q2FwYWJpbGl0aWVzOiB0aGlzLmluaXRPcHRpb25zLmNsaWVudENhcGFiaWxpdGllc1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBjYWNoZTogIXRoaXMuaW5pdE9wdGlvbnMuY2FjaGVMb2NhdGlvbiA/IG51bGwgOiB7XG4gICAgICAgICAgICAgICAgY2FjaGVMb2NhdGlvbjogdGhpcy5pbml0T3B0aW9ucy5jYWNoZUxvY2F0aW9uXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlID0gbmV3IG1zYWwuUHVibGljQ2xpZW50QXBwbGljYXRpb24oY29uZmlnKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTb2NpYWxVc2VyKGxvZ2luUmVzcG9uc2UpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8U29jaWFsVXNlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy9BZnRlciBsb2dpbiwgdXNlIE1pY3Jvc29mdCBHcmFwaCBBUEkgdG8gZ2V0IHVzZXIgaW5mb1xuICAgICAgbGV0IG1lUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgbWVSZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHtcbiAgICAgICAgaWYgKG1lUmVxdWVzdC5yZWFkeVN0YXRlID09IDQpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKG1lUmVxdWVzdC5zdGF0dXMgPT0gMjAwKSB7XG4gICAgICAgICAgICAgIGxldCB1c2VySW5mbyA9IDxNU0dyYXBoVXNlckluZm8+SlNPTi5wYXJzZShtZVJlcXVlc3QucmVzcG9uc2VUZXh0KTtcblxuICAgICAgICAgICAgICBsZXQgdXNlcjogU29jaWFsVXNlciA9IG5ldyBTb2NpYWxVc2VyKCk7XG4gICAgICAgICAgICAgIHVzZXIucHJvdmlkZXIgPSBNaWNyb3NvZnRMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lEO1xuICAgICAgICAgICAgICB1c2VyLmlkID0gbG9naW5SZXNwb25zZS5pZFRva2VuO1xuICAgICAgICAgICAgICB1c2VyLmF1dGhUb2tlbiA9IGxvZ2luUmVzcG9uc2UuYWNjZXNzVG9rZW47XG4gICAgICAgICAgICAgIHVzZXIubmFtZSA9IGxvZ2luUmVzcG9uc2UuaWRUb2tlbkNsYWltcy5uYW1lO1xuICAgICAgICAgICAgICB1c2VyLmVtYWlsID0gbG9naW5SZXNwb25zZS5hY2NvdW50LnVzZXJuYW1lO1xuICAgICAgICAgICAgICB1c2VyLmlkVG9rZW4gPSBsb2dpblJlc3BvbnNlLmlkVG9rZW47XG4gICAgICAgICAgICAgIHVzZXIucmVzcG9uc2UgPSBsb2dpblJlc3BvbnNlO1xuICAgICAgICAgICAgICB1c2VyLmZpcnN0TmFtZSA9IHVzZXJJbmZvLmdpdmVuTmFtZTtcbiAgICAgICAgICAgICAgdXNlci5sYXN0TmFtZSA9IHVzZXJJbmZvLnN1cm5hbWU7XG5cbiAgICAgICAgICAgICAgcmVzb2x2ZSh1c2VyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlamVjdChgRXJyb3IgcmV0cmlldmluZyB1c2VyIGluZm86ICR7bWVSZXF1ZXN0LnN0YXR1c31gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgLy9NaWNyb3NvZnQgR3JhcGggTUUgRW5kcG9pbnQ6IGh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL2dyYXBoL2FwaS91c2VyLWdldD92aWV3PWdyYXBoLXJlc3QtMS4wJnRhYnM9aHR0cFxuICAgICAgbWVSZXF1ZXN0Lm9wZW4oJ0dFVCcsICdodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20vdjEuMC9tZScpO1xuICAgICAgbWVSZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7bG9naW5SZXNwb25zZS5hY2Nlc3NUb2tlbn1gKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1lUmVxdWVzdC5zZW5kKCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRMb2dpblN0YXR1cygpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcbiAgICBjb25zdCBhY2NvdW50cyA9IHRoaXMuX2luc3RhbmNlLmdldEFsbEFjY291bnRzKCk7XG4gICAgaWYgKGFjY291bnRzPy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgdGhpcy5faW5zdGFuY2Uuc3NvU2lsZW50KHtcbiAgICAgICAgc2NvcGVzOiB0aGlzLmluaXRPcHRpb25zLnNjb3BlcyxcbiAgICAgICAgbG9naW5IaW50OiBhY2NvdW50c1swXS51c2VybmFtZVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTb2NpYWxVc2VyKGxvZ2luUmVzcG9uc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBgTm8gdXNlciBpcyBjdXJyZW50bHkgbG9nZ2VkIGluIHdpdGggJHtNaWNyb3NvZnRMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lEfWA7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2lnbkluKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xuICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9pbnN0YW5jZS5sb2dpblBvcHVwKHtcbiAgICAgIHNjb3BlczogdGhpcy5pbml0T3B0aW9ucy5zY29wZXNcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTb2NpYWxVc2VyKGxvZ2luUmVzcG9uc2UpO1xuICB9XG5cbiAgYXN5bmMgc2lnbk91dChyZXZva2U/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYWNjb3VudHMgPSB0aGlzLl9pbnN0YW5jZS5nZXRBbGxBY2NvdW50cygpO1xuICAgIGlmIChhY2NvdW50cz8ubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdGhpcy5faW5zdGFuY2UubG9nb3V0UG9wdXAoe1xuICAgICAgICBhY2NvdW50OiBhY2NvdW50c1swXSxcbiAgICAgICAgcG9zdExvZ291dFJlZGlyZWN0VXJpOiB0aGlzLmluaXRPcHRpb25zLmxvZ291dF9yZWRpcmVjdF91cmkgPz8gdGhpcy5pbml0T3B0aW9ucy5yZWRpcmVjdF91cmkgPz8gbG9jYXRpb24uaHJlZlxuICAgICAgfSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==